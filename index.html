<html>
  <head>
    <title>Bank Failures</title>
    <link rel="stylesheet" type="text/css" href="styles/styles.css">
    <link href="https://fonts.googleapis.com/css?family=Alfa+Slab+One" rel="stylesheet">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="//d3js.org/topojson.v1.min.js"></script>
  </head>

  <body>

    <div id='wrapper'>
      <div class='col1'>
        <h1 style='margin-bottom:10px;'>Bank Failures in the United States</h1>
        <p style='margin-top:0; font-size:22px; font-weight:700; color: #cccccc; font-family: Alfa Slab One, sans-serif'>1934 &ndash; 2016</p>

        <div class='text_col'>
          <p>
            Between the middle of the Great Depression in 1934 and 2016, nearly 3,500 banks failed
            in the United States. These failures spanned every level of financial organization,
            from tiny local savings unions to the biggest national banks and everything in between.
            Bank failures highlight not only how government and corporate policy changes affect
            economic stability nationwide, but also track the westward movement of the country's
            financial center. Moreover, the geographic distribution of failures sheds light on
            the often regional patterns of instability which emerge following even a single bank's
            insolvency, as its failure to secure the assets of other local and regional banks
            leads to a chain reaction of failures.

            The map belows displays the states which experienced bank failures in a given year, with
            the amount of assets lost in each state represented a color scale. The slider at the
            bottom surfaces the total assets lost nationwide each year on a logarithmic scale; a
            linear scale shows only the dramatic losses during the Savings and Loan Crisis and
            the Great Recession.
          </p>
        </div>
      </div>

      <div class='col2'>
        <h2 style='text-align: left; margin-bottom: 0'>
          "Between the middle of the Great Depression in 1934 and 2016, nearly 3,500 banks at every level failed
          in the United States"
        </h2>
      </div>

      <div id='viz' style='margin-bottom:35px'></div>

      <div class='col1' style='width:35%;'>
        <h2 id='crisis_subtitle'>
          "The Great Depression was the deepest economic downturn in the history of the United States"
        </h2>
      </div>

      <div class='col2' style='width:60%;'>
        <h2 style='color: #000; text-align: left; font-size: 22px; margin-bottom:5px; letter-spacing:0' id='crisis_title'>Great Depression</h2>
        <div class='text_col'>
          <p id='crisis_text'>
            The Great Depression was the deepest and longest-lasting economic downturn
            in the history of the Western industrialized world. In the United States, the Great
            Depression began soon after the stock market crash of October 1929, which sent Wall
            Street into a panic and wiped out millions of investors. Over the next several years,
            consumer spending and investment dropped, causing steep declines in industrial output
            and rising levels of unemployment as failing companies laid off workers. By 1933,
            when the Great Depression reached its nadir, some 13 to 15 million Americans were
            unemployed and nearly half of the countryâ€™s banks had failed. Though the relief and
            reform measures put into place by President Franklin D. Roosevelt helped lessen the
            worst effects of the Great Depression in the 1930s, the economy would not fully turn
            around until after 1939, when World War II kicked American industry into high gear.
          </p>
        </div>
      </div>
    </div>

      <script>
        var fipsDict = { 'AL': 01, 'AK': 02, 'AZ': 04, 'AR': 05, 'CA': 06,
                         'CO': 08, 'CT': 09, 'DE': 10, 'DC': 11, 'FL': 12,
                         'GA': 13, 'HI': 15, 'ID': 16, 'IL': 17, 'IN': 18,
                         'IA': 19, 'KS': 20, 'KY': 21, 'LA': 22, 'ME': 23,
                         'MD': 24, 'MA': 25, 'MI': 26, 'MN': 27, 'MS': 28,
                         'MO': 29, 'MT': 30, 'NE': 31, 'NV': 32, 'NH': 33,
                         'NJ': 34, 'NM': 35, 'NY': 36, 'NC': 37, 'ND': 38,
                         'OH': 39, 'OK': 40, 'OR': 41, 'PA': 42, 'RI': 44,
                         'SC': 45, 'SD': 46, 'TN': 47, 'TX': 48, 'UT': 49,
                         'VT': 50, 'VA': 51, 'WA': 53, 'WV': 54, 'WI': 55,
                         'WY': 56, };
        var timeData = [];

        function searchTimeData(arrayTime, state, year) {
          for (var t= 0; t< arrayTime.length; t++) {
            if (arrayTime[t].state == state && arrayTime[t].year == year) {
              return arrayTime[t];
            }
          }
          return null;
        }

        function yearCounts(arrayTime, year) {
          var max = arrayTime[0].count;
          var min = arrayTime[0].count;
          for (var t= 0; t< arrayTime.length; t++) {
            if (arrayTime[t].count > max && arrayTime[t].year == year) { max = arrayTime[t].count; }
            if (arrayTime[t].count < min && arrayTime[t].year == year) { min = arrayTime[t].count; }
          }
          return ([min, max]);
        }

        function yearAssets(arrayTime, year) {
          var max = arrayTime[0].totalAssets;
          var min = arrayTime[0].totalAssets;
          for (var t= 0; t< arrayTime.length; t++) {
            if (arrayTime[t].totalAssets > max && arrayTime[t].year == year) { max = arrayTime[t].totalAssets; }
            if (arrayTime[t].totalAssets < min && arrayTime[t].year == year) { min = arrayTime[t].totalAssets; }
          }
          return ([min, max]);
        }

        function assetsMinMax(arrayTime) {
          var max = arrayTime[0].totalAssets;
          var min = arrayTime[0].totalAssets;
          for (var t= 0; t< arrayTime.length; t++) {
            if (arrayTime[t].totalAssets > max) { max = arrayTime[t].totalAssets; }
            if (arrayTime[t].totalAssets < min) { min = arrayTime[t].totalAssets; }
          }
          return ([min, max]);
        }

        function formatPop(arrayPop, data){
            arrayPop.push(data);
        }

        function formatData(arrayBanks, data) {
          // Set up bank array
          var failDateRaw = data['Failure Date'].slice(0,data['Failure Date'].length-1);
          var slashFirst = failDateRaw.indexOf("/");
          var slashLast = failDateRaw.lastIndexOf("/");
          var failDateMonth = failDateRaw.substring(0,slashFirst);
          var failDateDay = failDateRaw.substring(slashFirst+1,slashLast);
          var failDateYear = failDateRaw.substring(slashLast+1,failDateRaw.length);
          if (failDateMonth.length == 1) { failDateMonth = "0"+failDateMonth; }
          if (failDateDay.length == 1) { failDateDay = "0"+failDateDay; }
          var failDateObj = new Date(failDateYear, parseInt(failDateMonth)-1, failDateDay);

          var headquartersComma = data.Headquarters.indexOf(",");
          var headquartersState = data.Headquarters.slice(headquartersComma+2, data.Headquarters.length);

          arrayBanks.push({
            name: data['Institution Name'],
            headquartersCity: data.Headquarters,
            headquartersState: headquartersState,
            headquartersFips: fipsDict[headquartersState],
            institutionType: data['Institution Type'],
            charterType: data['Charter Type'],
            transactionType: data['Transaction Type'],
            failDate: failDateObj,
            totalDeposits: parseInt(data['Total Deposits']),
            totalAssets: parseInt(data['Total Assets'])
          });

          // Set up time array
          var match = searchTimeData(timeData, headquartersState, failDateObj.getFullYear());
          if (match == null) {
            timeData.push({ state: headquartersState,
                            year: failDateObj.getFullYear(),
                            count: 1,
                            totalDeposits: parseInt(data['Total Deposits']),
                            totalAssets: parseInt(data['Total Assets'])
                          });
          } else {
            match.count++;
            match.totalDeposits += parseInt(data['Total Deposits']);
            match.totalAssets += parseInt(data['Total Assets']);
          }
        }

        var bankData = [];
        var populationData =[];
        var stat = [];
        stat.s01 = [];
        stat.s02 = [];
        stat.s03 = [];
        stat.s04 = [];
        stat.s05 = [];
        stat.s06 = [];
        stat.s07 = [];
        stat.s08 = [];
        stat.s09 = [];
        stat.s10 = [];
        stat.s11 = [];
        stat.s12 = [];
        stat.s13 = [];
        stat.s14 = [];
        stat.s15 = [];
        stat.s16 = [];
        stat.s17 = [];
        stat.s18 = [];
        stat.s19 = [];
        stat.s20 = [];
        stat.s21 = [];
        stat.s22 = [];
        stat.s23 = [];
        stat.s24 = [];
        stat.s25 = [];
        stat.s26 = [];
        stat.s27 = [];
        stat.s28 = [];
        stat.s29 = [];
        stat.s30 = [];
        stat.s31 = [];
        stat.s32 = [];
        stat.s33 = [];
        stat.s34 = [];
        stat.s35 = [];
        stat.s36 = [];
        stat.s37 = [];
        stat.s38 = [];
        stat.s39 = [];
        stat.s40 = [];
        stat.s41 = [];
        stat.s42 = [];
        stat.s43 = [];
        stat.s44 = [];
        stat.s45 = [];
        stat.s46 = [];
        stat.s47 = [];
        stat.s48 = [];
        stat.s49 = [];
        stat.s50 = [];
        stat.s51 = [];
        stat.s52 = [];
        stat.s53 = [];
        stat.s54 = [];
        stat.s55 = [];
        stat.s56 = [];

        for(var i = 1; i<57; i++){
            s = String(i);
            if (i < 10){
                s = "0"+i;
            }
            s = "s"+s;
            for (var y = 0; y < 90; y++){
                stat[s][y] = {
                    numAssets: 0,
                    MERGER: 0,
                    ACQUISITION: 0,
                    PAYOUT: 0,
                    PRIVATIZATION: 0,
                    TRANSFER: 0,
                    'COMMERCIAL BANK': 0,
                    'SAVINGS ASSOCIATION': 0,
                    'SAVINGS BANK': 0
                };
            }
        }

        d3.queue()
          .defer(d3.csv, "data/banks.csv", function(data) { formatData(bankData, data); })
          .defer(function(callback) { d3.json("data/us.json", function(data) { callback(null, data); }) })
          .defer(d3.csv, "data/population.csv", function(d){ formatPop(populationData, d); })
          .awaitAll(function(error, data) {
            if (error) { console.log("Error: "+error); }
            else {
              // Set up document
              var viz = document.getElementById("viz");
              var svg = d3.select(viz).append("svg");
              var height = 640;
              svg.attr("width","60%")
                 .attr("height",height);
              var width = document.getElementsByTagName("svg")[0].getClientRects()[0].width;
              var paddingWidth = document.getElementsByTagName("div")[0].offsetLeft;

              svg.append("text")
                .attr("id", "choro_title")
                .attr("x", 0)
                .attr("y", 24)
                .style("font-size", "22px")
                .style("font-weight", 700)
                .style("font-family", "'Alfa Slab One', sans-serif")
                .text("Bank Failures in 1934");

              svg.append("text")
                .attr("id", "choro_subtitle")
                .attr("x", 280)
                .attr("y", 23)
                .style("font-size", "22px")
                .style("font-weight", 700)
                .style("font-family", "'Alfa Slab One', sans-serif")
                .style("fill", d3.hsl(0, 1, .75))
                .text("Great Depression");

              // Legend setup
              var defs = svg.append("defs");
              defs.attr("id", "legendDefs")
              var legendGradient = document.createElementNS("http://www.w3.org/2000/svg", "linearGradient");
              legendGradient.setAttribute("id", "legend");
              legendGradient.setAttribute("x1", "0%");
              legendGradient.setAttribute("x2", "100%");
              legendGradient.setAttribute("y1", "0%");
              legendGradient.setAttribute("y2", "0%");
              document.getElementById("legendDefs").appendChild(legendGradient);
              var stop1 = document.createElementNS("http://www.w3.org/2000/svg", "stop");
              stop1.setAttribute("id", "stopGrey");
              stop1.setAttribute("offset", "20%");
              stop1.setAttribute("stop-color", "#cccccc");
              legendGradient.appendChild(stop1);
              var stop2 = document.createElementNS("http://www.w3.org/2000/svg", "stop");
              stop2.setAttribute("id", "stopPink");
              stop2.setAttribute("offset", "80%");
              stop2.setAttribute("stop-color", "#ff9999");
              legendGradient.appendChild(stop2);

              svg.append("rect")
                .attr("x", 0)
                .attr("y", 35)
                .attr("height", 6)
                .attr("width", 265)
                .attr("rx", 3)
                .attr("ry", 3)
                .attr("fill", "url(#legend)")

              svg.append("text")
                .attr("id", "legendMin")
                .attr("x", 0)
                .attr("y", 57)
                .style("font-size", "12px")
                .text("-$â€“");

              svg.append("text")
                .attr("id", "legendMax")
                .attr("x", 265)
                .attr("y", 57)
                .attr("text-anchor", "end")
                .style("font-size", "12px")
                .text("-$â€“");

              svg.append("text")
                .attr("x", 7)
                .attr("y", height-10)
                .style("font-size", "12px")
                .style("fill", "#cccccc")
                .text("Assets lost (log scale)");
              // End legend setup

              var svg2 = d3.select(viz).append("svg");
              svg2.attr("width","35%")
                 .attr("height", height)
                 .style("float", "right");
              var svg2_width = document.getElementsByTagName("svg")[1].getClientRects()[0].width;

              svg2.append("text")
                .attr("id", "svg2_title")
                .attr("x", 0)
                .attr("y", 24)
                .style("font-size", "22px")
                .style("font-weight", 700)
                .style("font-family", "'Alfa Slab One', sans-serif")
                .text("Biggest failure of 1934");

              svg2.append("text")
                .attr("id", "svg2_subtitle")
                .attr("x", 0)
                .attr("y", 50)
                .style("font-size", "18px")
                .style("font-weight", 400)
                .text("BANK OF AMERICA TRUST CO.");

              var currentYear = 1934;
              // Map setup
              var us = data[1];
              var projection = d3.geoAlbersUsa()
                  .scale(900)
                  .translate([width / 2, (height / 2)-5])
                  .precision(.1);
              var path = d3.geoPath()
                  .projection(projection);
              var graticule = d3.geoGraticule()
                  .extent([[-98 - 45, 38 - 45], [-98 + 45, 38 + 45]])
                  .step([5, 5]);



              function showMap(year) {
                var yearMinMax = yearAssets(timeData, year);
                var cScale = d3.scaleLinear().domain(yearMinMax).range([0,1]);
                var selectedState;

                  bankData.forEach(function(f){
                      var fips = f.headquartersFips;
                      if(f.headquartersFips != undefined) {
                          if (fips < 10) {
                              fips = '0' + String(fips);
                          }
                          var i = "s" + String(fips);
                          stat[i][f.failDate.getFullYear() - 1930][f.institutionType] += 1;
                          stat[i][f.failDate.getFullYear() - 1930][f.transactionType] += 1;
                          stat[i][f.failDate.getFullYear() - 1930].numAssets += f.totalAssets;

                      }

                  })

                svg.append("g") // individual state fills
                  .attr("id", "stateMap")
                  .selectAll("path")
                  .data(topojson.feature(us, us.objects.states).features)
                  .enter().append("path")
                    .attr("fill", function(d) {
                      // Find matching state
                      for (n in timeData) {
                        var state = timeData[n].state;
                        if (fipsDict[state] == d.id && timeData[n].year == year) {
                          return d3.hsl(0, cScale(timeData[n].totalAssets), .8);
                        }
                      }
                      return "#d9d9d9";
                    })
                    .attr("d", path)
                    .on('click', function(d){
                        if (selectedState != null) { selectedState.style("stroke", "none") }
                        d3.select(this.parentNode.appendChild(this)) // Makes state outlines more uniform
                          .style('stroke-opacity', 1)
                          .style('stroke', '#F00');
                        selectedState = d3.select(this);
                        selectedState.style("stroke", "#808080")
                            .style("stroke-width", "1px");
                        zoomInfo(d);
                    });

                  var popData = [];



                  var popIndexMap = d3.map(populationData, function(d){
                      if (d.id > 9) {return d.id};
                      return Number("0"+String(d.id));

                  });


                  //get an average of the assets for each year;

                //get an average of the values for each object;

                  var averageAssets = [];
                  for(var num = 0; num < 90; num++){
                      averageAssets[num] = 0;
                  }
                  for(var s = 1; s < 57; s++) {
                      var state = '';
                      state = s;
                      if(s<10){
                        state = '0' + s;
                      }
                      state = 's' + state;
                      var stateData = stat[state];
                      for(year = 0; year < 90; year++){
                          if(!isNaN(stateData[year].numAssets)) {
                              averageAssets[year] += stateData[year].numAssets;
                          }
                      }
                  }
                  for(var num = 0; num < 90; num++){
                      averageAssets[num]/=51;
                  }

                  //get an average of the populations for each year
                  var averagePopulation = [];
                  for(var y = 0; y <9; y++){
                      averagePopulation[y] = 0;
                  }
                 // console.log(averagePopulation)
                  for(a = 0; a < 52; a++){
                     // console.log(populationData[a]['2010']);
                      averagePopulation[0] += populationData[a]['1930']/51;
                      averagePopulation[1] += populationData[a]['1940']/51;
                      averagePopulation[2] += populationData[a]['1950']/51;
                      averagePopulation[3] += populationData[a]['1960']/51;
                      averagePopulation[4] += populationData[a]['1970']/51;
                      averagePopulation[5] += populationData[a]['1980']/51;
                      averagePopulation[6] += populationData[a]['1990']/51;
                      averagePopulation[7] += populationData[a]['2000']/51;
                      if(a<51) {
                          averagePopulation[8] += populationData[a]['2010'] / 50;
                      };
                  }

                  var populationExtent = d3.extent(averagePopulation);
                  var assetExtent = d3.extent(averageAssets);

                  var yearScale2 = d3.scaleLinear().domain([0,svg2_width-4]).range([1934,2016]);
                  var svg2Padding = 22;
                  var xScale2 = d3.scaleTime().domain([new Date(1934,0,1),new Date(2016,0,1)]).range([svg2Padding,svg2_width-svg2Padding]);
                  var scalePopulationIndex = d3.scaleLinear().domain([0,averagePopulation.length-1]).range([new Date(1934,0,1),new Date(2016,0,1)]);
                  var scaleAssetIndex = d3.scaleLinear().domain([0,averageAssets.length-1]).range([new Date(1934,0,1),new Date(2016,0,1)]);
                  var yScale2AveragePop = d3.scaleLinear().domain(populationExtent).range([100,0]);

                  // Graph 1
                  svg2.append("g")
                    .attr("class", "axisPop")
                    .attr("transform", "translate(18, 170)")
                    .call(d3.axisBottom(xScale2))
                  var yScale3 = d3.scaleLinear().domain(assetExtent).range([70,0]);
                  svg2.append("g")
                    .attr("transform", "translate(40, 100)")
                    .attr("id", "yAxis1")
                    .attr("class", "axisAssets")
                    .call(d3.axisLeft(yScale3)
                        .tickFormat(d3.format(".2s")));
                  var areaAverageAsset = d3.area()
                    .x(function(d) { return xScale2(scaleAssetIndex(averageAssets.indexOf(d))) })
                    .y1(function(d) { return yScale3(d) })
                    .y0(70)
                  svg2.append("path")
                    .datum(averageAssets)
                    .attr("fill", "#d9d9d9")
                    .attr("d", areaAverageAsset)
                    .attr("opacity", ".4")
                    .attr("stroke", "black")
                    .attr("transform", "translate(19, 100)");

                  // Graph 2
                  svg2.append("g")
                    .attr("class", "axisPop")
                    .attr("transform", "translate(18, 300)")
                    .call(d3.axisBottom(xScale2))
                  var yScale2Average = d3.scaleLinear().domain(populationExtent).range([70,0]);
                  svg2.append("g")
                    .attr("transform", "translate(40, 230)")
                    .attr("id", "yAxis2")
                    .call(d3.axisLeft(yScale2Average)
                        .tickFormat(d3.format(".2s")));

               //   var area = d3.area()
               // .x(function(d) { return xScale2(new Date(d.year, 0, 1)) })
               // .y1(function(d) { return yScale(d.totalDeposits) })
                //.y0(39)

                // Graph 3
                svg2.append("g")
                  .attr("class", "axisPop")
                  .attr("transform", "translate(18, 430)")
                  .call(d3.axisBottom(xScale2))
                var yScale2AveragePop = d3.scaleLinear().domain(populationExtent).range([70,0]);
                svg2.append("g")
                  .attr("transform", "translate(40, 360)")
                  .attr("id", "yAxis3")
                  .call(d3.axisLeft(yScale2AveragePop)
                    .tickFormat(d3.format(".2s")));
                var areaAveragePop = d3.area()
                  .x(function(d) { return xScale2(scalePopulationIndex(averagePopulation.indexOf(d))) })
                  .y1(function(d) { return yScale2AveragePop(d) })
                  .y0(70)
                svg2.append("path")
                  .datum(averagePopulation)
                  .attr("fill", "#00ffff")
                  .attr("opacity", ".4")
                  .attr("d", areaAveragePop)
                  .attr("transform", "translate(19, 360)");

                  svg2.append("path")
                    .datum(averagePopulation)
                    .attr("id", "populationLine")
                    .attr("fill", "#ff0000")
                    .attr("opacity", ".01")
                    .attr("d", areaAveragePop)
                    .attr("stroke", "black")
                    .attr("transform", "translate(19, 360)")
                    .transition()
                    .duration(500);

                // Graph 4
                svg2.append("g")
                  .attr("class", "axisPop")
                  .attr("transform", "translate(18, 560)")
                  .call(d3.axisBottom(xScale2))
                var yScale4 = d3.scaleLog().domain(averageAssets[0], averageAssets[averageAssets.length-1]).range([70,0]);
                svg2.append("g")
                    .attr("id", "yAxis4")
                    .attr("class", "axisAssets")
                    .attr("transform", "translate(40, 490)")
                    .call(d3.axisLeft(yScale3)
                        .tickFormat(d3.format(".2s")));

                function zoomInfo(d){
                  popData = [];
                  //d3.select("#yAxis2").remove();
                  var state = popIndexMap.get(d.id);
                  
                  //console.log(populationLine);
                  //grab the population data of the clicked state
                  for(var i = 1930; i <= 2010; i= i + 10){
                      year = String(i);
                      popData.push(state[year]);
                  }
                  stateid = d.id;
                  if (stateid<10){stateid = '0' + stateid;}
                  stateid = 's'+stateid;
                  var stateArray = stat[stateid];
                  //console.log(stateArray);
                 // console.log(stateArray);
                  var popArray = popData;
                  var popArrayExtent = d3.extent(popArray);
                  //id.text(popArray);
                   var scaleThisPopulationIndex = d3.scaleLinear().domain([0,popArray.length-1]).range([new Date(1934,0,1),new Date(2016,0,1)]);
                   var yScale2Pop = d3.scaleLinear().domain(popArrayExtent).range([100,0]);

                  var areaThisPopulation = d3.area()
                    .x(function(d) { return xScale2(scaleThisPopulationIndex(popArray.indexOf(d))) })
                    .y1(function(d) { return yScale2Pop(d) })
                    .y0(70)

                    d3.select("path#populationLine")
                    .datum(popArray)
                    .attr("fill", "#ff0000")
                    .attr("opacity", ".4")
                    .attr("d", areaThisPopulation)
                    .attr("stroke", "black")
                    .attr("transform", "translate(19, 360)");

                   //d3.select("path#populationLine").transition()
                 // .duration(500)
                 // .attr("datum", popArray)
                //    .attr("d", areaThisPopulation)
                //    .attr("stroke", "black")
                //    .attr("transform", "translate(19, 360)");
                }

                var yearMin = Intl.NumberFormat().format(parseInt(yearMinMax[0]+"000"));
                var yearMax = Intl.NumberFormat().format(parseInt(yearMinMax[1]+"000"));
                svg.select("#legendMin")
                  .text("-$"+yearMin)
                svg.select("#legendMax")
                  .text("-$"+yearMax)
            }

              function updateMap(year) {
                var updateSubtitle = false;
                var yearMinMax = yearAssets(timeData, year);
                var cScale = d3.scaleLinear().domain(yearMinMax).range([0,1]);
                var biggestFail = null;
                var biggestFailAssets = 0;
                var stateMap = d3.select("#stateMap");
                stateMap.selectAll("path")
                    .transition()
                    .attr("fill", function(d) {
                      if (d != null) {
                        // Find matching state
                        for (n in timeData) {
                          var state = timeData[n].state;
                          if (fipsDict[state] == d.id && timeData[n].year == year) {
                            if (timeData[n].totalAssets > biggestFailAssets) {
                              for (b in bankData) {
                                if (bankData[b].totalAssets == timeData[n].totalAssets) {
                                  biggestFail = bankData[b];
                                }
                              }
                            }
                            return d3.hsl(0, cScale(timeData[n].totalAssets), .8);
                          }
                        }
                        return "#d9d9d9";
                      }
                    })
                    .attr("d", path);

                svg.select("#choro_title")
                  .text("Bank Failures in "+year);
                svg2.select("#svg2_title")
                  .text("Biggest Failure of "+year);
                if (biggestFail == null) {
                  svg2.select("#svg2_subtitle")
                    .text("No failures");
                } else {
                  svg2.select("#svg2_subtitle")
                    .text(biggestFail.name);
                }

                var yearMin = Intl.NumberFormat().format(parseInt(yearMinMax[0]+"000"));
                var yearMax = Intl.NumberFormat().format(parseInt(yearMinMax[1]+"000"));
                svg.select("#legendMin")
                  .text("-$"+yearMin)
                svg.select("#legendMax")
                  .text("-$"+yearMax)

                // Update subtitles
                for (y in importantRanges) {
                  var compareRange = importantRanges[y];
                  if (year >= compareRange.start && year <= compareRange.end) {
                    svg.select("#choro_subtitle")
                      .text(compareRange.name);
                    document.getElementById("crisis_title").innerHTML = compareRange.name;
                    document.getElementById("crisis_subtitle").innerHTML = compareRange.subtitle;
                    document.getElementById("crisis_text").innerHTML = compareRange.desc;
                    updateSubtitle = true;
                  }
                }
                if (!updateSubtitle) {
                  svg.select("#choro_subtitle")
                    .text("");
                }
              }

              showMap(currentYear);

              // Create slider
              var yearScale = d3.scaleLinear().domain([0,width-4]).range([1934,2016]); // converts pixel-coordinates to years

              var xScale = d3.scaleTime().domain([new Date(1934,0,1),new Date(2016,0,1)]).range([4,width-8]); // converts years to pixel coordinates
              var ticks = xScale.ticks(51);
              var tickFormat = xScale.tickFormat(51);
              ticks.map(tickFormat);
              var xAxis = d3.axisBottom(xScale)
                .ticks(20)
              var plotXAxis = svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(4,"+(height-48)+")")
                .call(xAxis);

              var assets = assetsMinMax(timeData);
              var yScale = d3.scaleLog().domain([assets[0], assets[1]]).range([40,0]);

              var area = d3.area()
                .x(function(d) { return xScale(new Date(d.year, 0, 1)) })
                .y1(function(d) { return yScale(d.totalDeposits) })
                .y0(39)

              var assetsSlider = svg.append("g")
                .attr("transform", "translate(0,"+(height-87)+")")
                .attr("id", "sliderPath")
                .on("click", function(){
                  //When the slider is clicked the handler moves and updates the slider
                  var newYear = parseInt(yearScale(d3.event.x))-17;
                   //console.log(newYear);
                   //console.log(d3.event.x);
                  assetsHandle.attr("x", yearScale.invert(newYear));

                  if (newYear != currentYear && newYear >= 1934 && newYear <= 2016) {
                              assetsHandle.attr("x", yearScale.invert(newYear));
                              currentYear = newYear;
                              updateMap(newYear);
                            }
                })
                .call(d3.drag()
                        .on("start drag", function() {
                            var newYear = parseInt(yearScale(d3.event.x));
                            if (newYear != currentYear && newYear >= 1934 && newYear <= 2016) {
                              assetsHandle.attr("x", d3.event.x);
                              currentYear = newYear;
                              updateMap(newYear);
                            }
                        }));
              assetsSlider.append("path")
                .datum(timeData)
                .attr("fill", "#d9d9d9")

                .attr("d", area);

              var importantRanges = [ { start: 1934,
                                        end: 1939,
                                        name: "Great Depression",
                                        subtitle: "&quot;The Great Depression was the deepest economic downturn in the history of the United States&quot;",
                                        desc: "The Great Depression was the deepest and longest-lasting economic downturn in the history of the Western industrialized world. In the United States, the Great Depression began soon after the stock market crash of October 1929, which sent Wall Street into a panic and wiped out millions of investors. Over the next several years, consumer spending and investment dropped, causing steep declines in industrial output and rising levels of unemployment as failing companies laid off workers. By 1933, when the Great Depression reached its nadir, some 13 to 15 million Americans were unemployed and nearly half of the countryâ€™s banks had failed. Though the relief and reform measures put into place by President Franklin D. Roosevelt helped lessen the worst effects of the Great Depression in the 1930s, the economy would not fully turn around until after 1939, when World War II kicked American industry into high gear."
                                        // Adapted from: http://www.history.com/topics/great-depression
                                      },
                                      { start: 1982,
                                        end: 1994,
                                        name: "Savings and Loans Crisis",
                                        subtitle: "&quot;The S&L Crisis is arguably the most catastrophic collapse of the banking industry since the Great Depression&quot;",
                                        desc: "The Savings and Loan (S&L) Crisis began under the volatile interest rate climate of the 1970s, when vast numbers of depositors removed their money from the S&L institutions and deposited it in money market funds. This allowed for higher interest rates, because the funds were not governed by Regulation Q. Once regulations were loosened, S&Ls began engaging in high-risk activities, such as commercial real estate lending and investments in junk bonds, to cover losses. Depositors in S&Ls continued to funnel money into these risky endeavors because their deposits were insured by the Federal Savings and Loan Insurance Corporation (FSLIC). Widespread corruption and other factors led to the insolvency of the FSLIC, the $124 billion bailout of junk bond investments and the liquidation of more than 700 S&Ls by the Resolution Trust Corporation. The S&L Crisis is arguably the most catastrophic collapse of the banking industry since the Great Depression. Across the United States, more than 1,000 S&Ls failed by 1989, essentially ending one of the most secure sources of home mortgages."
                                        // Adapted from: http://www.investopedia.com/terms/s/sl-crisis.asp
                                      },
                                      { start: 2007,
                                        end: 2010,
                                        name: "Great Recession",
                                        subtitle: "&quot;As a result of the Great Recession, the United States alone shed more than 7.5 million jobs&quot;",
                                        desc: "During the American housing boom of the mid-2000s, financial institutions began marketing mortgage-backed securities (MBSs) and sophisticated derivative products at unprecedented levels. When the real estate market collapsed in 2007, these securities declined precipitously in value, jeopardizing the solvency of over-leveraged banks and financial institutions in the U.S. and Europe. Although the global economy was already feeling the grip of a credit crisis that had been unfolding since 2007, things came to a head a year later with the bankruptcy of Lehman Brothers, the countryâ€™s fourth-largest investment bank, in September 2008. The contagion quickly spread to other economies around the world, most notably in Europe. As a result of the Great Recession, the United States alone shed more than 7.5 million jobs, causing its unemployment rate to double. Further, American households lost roughly $16 trillion of net worth as a result of the stock market plunge."
                                        // Adapted from: http://www.investopedia.com/terms/g/great-recession.asp
                                      }];
              for (e in importantRanges) {
                var rangeStart = xScale(new Date(importantRanges[e].start, 0, 1));
                var rangeEnd = xScale(new Date(importantRanges[e].end, 0, 1));
                var rangeWidth = rangeEnd-rangeStart;
                assetsSlider.append("rect")
                  .attr("width", rangeWidth)
                  .attr("height", 6)
                  .attr("x", rangeStart)
                  .attr("y", 34)
                  .attr("fill", d3.hsl(0, 1, .75))
                  .attr("rx", 3)
                  .attr("ry", 3);
              }

              var assetsHandle = assetsSlider.insert("rect")
                .attr("height", 35)
                .attr("width", 1)
                .attr("x", 4)
                .attr("y", 5)
                .attr("rx",4)
                .attr("fill", "#000")
                .attr("id", "assetsHandle")
            }
          });
      </script>
  </body>
</html>
